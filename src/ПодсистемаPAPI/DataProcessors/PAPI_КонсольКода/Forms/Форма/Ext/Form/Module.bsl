#Область КонсольКода

// Добавлена консоль кода Monaco https://github.com/salexdv/bsl_console 
// На основе разработки https://infostart.ru/1c/tools/1989363/

#КонецОбласти

#Область УправлениеФормой

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьУсловноеОформлениеРеквизита(Форма, Обработано, ИмяРеквизита)

	Если НЕ Обработано.Найти(ИмяРеквизита) = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Обработано.Добавить(ИмяРеквизита);

	Элементы	= Форма.Элементы;
	Объект		= Форма.Объект;

	#Область Наборы
	
	Если ИмяРеквизита = "РеквизитыРежимаСравнения" ИЛИ ПустаяСтрока(ИмяРеквизита) Тогда
		УстановитьУсловноеОформлениеРеквизита(Форма, Обработано, "ГруппаПодсказкаАлгоритмаОбработки");
	КонецЕсли;

	#КонецОбласти
	
	#Область Элементы
	
	Если ИмяРеквизита = "ГруппаПодсказкаАлгоритмаОбработки" Тогда
		PAPI_ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы,
			"ГруппаПодсказкаАлгоритмаОбработки", "Видимость", 
			НЕ Форма.РежимЗапроса);
	КонецЕсли;

	#КонецОбласти 
	
	#Область Команды
	
	Если ИмяРеквизита = "КомандаЗаписатьИЗакрыть" ИЛИ ПустаяСтрока(ИмяРеквизита) Тогда
		PAPI_ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы,
			"ЗаписатьИЗакрыть", "Видимость",
			НЕ Форма.ТолькоПросмотр);
	КонецЕсли;

	#КонецОбласти 
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьУсловноеОформление(Форма, ИменаРеквизитов = "")

	Если ТипЗнч(ИменаРеквизитов) = Тип("Строка") Тогда
		Если ПустаяСтрока(ИменаРеквизитов) Тогда
			МассивИмен = Новый Массив;
			МассивИмен.Добавить("");
		Иначе                                               
			//МассивИмен = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ИменаРеквизитов, ",");
			МассивИмен = СтрРазделить(ИменаРеквизитов, ",");
		КонецЕсли;
	ИначеЕсли ТипЗнч(ИменаРеквизитов) = Тип("Массив") Тогда
		МассивИмен = ИменаРеквизитов;
	Иначе
		Возврат;
	КонецЕсли;

	Обработано = Новый Массив;
	Для Каждого ИмяРеквизита Из МассивИмен Цикл
		УстановитьУсловноеОформлениеРеквизита(Форма, Обработано, СокрЛП(ИмяРеквизита));
	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ТекстHTMLДокументСформирован(Элемент)
	
	PAPI_КонсольКодаКлиент.КонсольДокументСформирован(ЭтотОбъект, "ТекстHTML", Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура ТекстHTMLПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)
	
	PAPI_КонсольКодаКлиент.КонсольПриНажатии(ЭтотОбъект, "ТекстHTML", Элемент, ДанныеСобытия, СтандартнаяОбработка);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	ЭтотОбъект.Заголовок			= Параметры.Заголовок;
	ЭтотОбъект.ТекстАлгоритма		= Параметры.ТекстАлгоритма;
	ЭтотОбъект.РежимЗапроса			= Параметры.РежимЗапроса;
	ЭтотОбъект.ДирективаКомпиляции	= Параметры.ДирективаКомпиляции;
	
	Если ЭтотОбъект.РежимЗапроса Тогда
		ЭтотОбъект.ДирективаКомпиляции = "НаСервере";
	КонецЕсли;
	
	PAPI_КонсольКода.ПриСозданииНаСервере(ЭтотОбъект, Отказ, СтандартнаяОбработка);
	
	ПараметрыПанели = PAPI_КонсольКодаКлиентСервер.ПараметрыПанелиКонсоли();
	ПараметрыПанели.ИзменятьКомпиляцию = ПустаяСтрока(ЭтотОбъект.ДирективаКомпиляции);
	PAPI_КонсольКода.ИнициализацияКоманднойПанели(ЭтотОбъект, "ТекстHTML", Элементы.КоманднаяПанельКонсольКода, ПараметрыПанели);
	
КонецПроцедуры

&НаКлиенте
Асинх Процедура ПриОткрытии(Отказ)
	
	Результат = Ждать PAPI_КонсольКодаКлиент.ПриОткрытииАсинх(ЭтотОбъект, Отказ);
	
	Если НЕ Результат.Выполнено Тогда
		ВызватьИсключение НСтр("ru='Ошибка при открытии формы консоли кода: '") + Результат.ТекстОшибки;
	КонецЕсли;

	Ждать PAPI_КонсольКодаКлиент.ИнициализацияПоляАсинх(ЭтотОбъект, "ТекстHTML");
	
	УстановитьУсловноеОформление(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	
	Оповещение = Новый ОписаниеОповещения("ПередЗакрытиемЗавершение", ЭтотОбъект);
	//ОбщегоНазначенияКлиент.ПоказатьПодтверждениеЗакрытияФормы(Оповещение,
	//	Отказ,
	//	ЗавершениеРаботы);
	PAPI_ОбщегоНазначенияКлиент.ПоказатьПодтверждениеЗакрытияФормы(Оповещение,
		Отказ,
		ЗавершениеРаботы);
		
	Если Не Отказ Тогда
		PAPI_КонсольКодаКлиент.ПередЗакрытиемАсинх(ЭтотОбъект, Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка);
	КонецЕсли;
	
КонецПроцедуры




&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗаписатьИЗакрыть(Команда)
	ЗаписатьИЗакрытьНаКлиенте();
КонецПроцедуры

&НаКлиенте
Процедура КомандаКонсолиКода(Команда)
	
	PAPI_КонсольКодаКлиент.ВыполнитьКомандуКонсолиКода(ЭтотОбъект, Команда);
	
КонецПроцедуры

#КонецОбласти

#Область ЗавершениеНемодальныхВызовов

&НаКлиенте 
Процедура ПослеИнициализациПоляКонсоли(знач ИмяРеквизита, знач ДопПараметры) Экспорт

	Если ИмяРеквизита <> "ТекстHTML" Тогда
		Возврат;
	КонецЕсли;
	
	Консоль = PAPI_КонсольКодаКлиент.ЭтаКонсоль(ЭтотОбъект, ИмяРеквизита);
	
	PAPI_КонсольКодаКлиент.УстановитьДирективуКомпиляции(Консоль, ЭтотОбъект.ДирективаКомпиляции, Ложь);
	PAPI_КонсольКодаКлиент.ОбнулитьМетаданные(Консоль); // выполняется в методе УстановитьДирективуКомпиляции
	PAPI_КонсольКодаКлиент.РежимЗапроса(Консоль, ЭтотОбъект.РежимЗапроса);
	PAPI_КонсольКодаКлиент.УстановитьТекст(Консоль, ЭтотОбъект.ТекстАлгоритма);
	PAPI_КонсольКодаКлиент.УстановитьОригинальныйТекст(Консоль, ЭтотОбъект.ТекстАлгоритма);
	
	PAPI_КонсольКодаКлиент.ПодсвечиватьЗапросы(Консоль, ЭтотОбъект.РежимЗапроса);
	
	PAPI_КонсольКодаКлиент.ЗагрузитьПользовательскиеОбъекты(Консоль, ЭтотОбъект.Параметры.ПользовательскиеОбъекты);
		
	//PAPI_КонсольКодаКлиент.ДоступностьСравнения(Консоль, Ложь);
	//PAPI_КонсольКодаКлиент.БыстрыеПодсказки(Консоль, Ложь);
	//PAPI_КонсольКодаКлиент.КартаКода(Консоль, Ложь);
	
КонецПроцедуры

&НаКлиенте 
Процедура ПриИзмененииПоляКонсоли(знач Консоль) Экспорт
	
	//ЗапросТекст = PAPI_КонсольКодаКлиент.ПолучитьТекст(Консоль);
	//
	//ЗаписатьТекстЗапроса(ЗапросТекст);
	//
	//ЭтотОбъект.ТекстЗапроса.УстановитьТекст(ЗапросТекст);
	
КонецПроцедуры

&НаКлиенте 
Процедура ПередЗакрытиемЗавершение(Результат, ДопПараметры) Экспорт
	
	ЗаписатьИЗакрытьНаКлиенте(); 

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте 
Процедура ЗаписатьИЗакрытьНаКлиенте()
	Если ЭтотОбъект.Модифицированность Тогда
		Консоль = PAPI_КонсольКодаКлиент.ЭтаКонсоль(ЭтотОбъект, "ТекстHTML");
		ТекстКода = PAPI_КонсольКодаКлиент.ПолучитьТекст(Консоль);
	Иначе 
		ТекстКода = Неопределено;
	КонецЕсли;
	
	Если ЭтотОбъект.Модифицированность Тогда
		ЭтотОбъект.Модифицированность = Ложь;
			
		Если ЭтотОбъект.Параметры.РежимВыбора Тогда
			ЭтотОбъект.ЗакрыватьПриВыборе = Ложь;
			ЭтотОбъект.ОповеститьОВыборе(ТекстКода);
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЭтотОбъект.Открыта() Тогда
		ЭтотОбъект.Закрыть(ТекстКода);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте 
Процедура ЗагрузитьВременныеТаблицыВПользовательскиеОбъекты(Консоль)
	
	
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции_Раздел
#КонецОбласти


